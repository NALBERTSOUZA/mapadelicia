<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa de Mesas • Restaurante</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  height:100vh;
  display:flex;
}
#overlay{
  position:fixed;
  inset:0;
  background:#020617;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:9999;
}
#overlay.error{background:#7f1d1d}
#overlay.hidden{display:none}

aside{
  width:280px;
  background:#0f172a;
  color:#fff;
  padding:16px;
}
.elementos{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
.elemento{
  background:#020617;
  border:1px dashed #475569;
  border-radius:6px;
  padding:6px;
  cursor:grab;
  display:flex;
  justify-content:center;
}
.elemento img{width:42px}

main{flex:1}
#viewport{width:100%;height:100%;overflow-x:auto;background:#e5e7eb}
#mapa{width:6000px;height:100%;position:relative;background:#fff}

.item-mapa{
  position:absolute;
  width:150px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.item-mapa img{width:150px}
</style>
</head>

<body>

<div id="overlay">
  <h2>Carregando mapa…</h2>
  <small id="status">Inicializando</small>
</div>

<aside>
  <h3>Reserváveis</h3>
  <div class="elementos" id="listaReservaveis"></div>

  <h3>Não reserváveis</h3>
  <div class="elementos" id="listaNaoReservaveis"></div>
</aside>

<main>
  <div id="viewport">
    <div id="mapa"></div>
  </div>
</main>

<script>
/* ================= SUPABASE ================= */
const supabase = window.supabase.createClient(
  'https://fzyosadzuvbktvmnzdpf.supabase.co',
  'sb_publishable_VuMi0uFLuzTAPdSL36uyNg_YhD_uPK0'
)

/* ================= REFS ================= */
const overlay = document.getElementById('overlay')
const status = document.getElementById('status')
const mapa = document.getElementById('mapa')
const listaRes = document.getElementById('listaReservaveis')
const listaNao = document.getElementById('listaNaoReservaveis')

/* ================= LOAD ELEMENTOS ================= */
async function carregarElementos(){
  status.textContent = 'Carregando elementos…'

  const { data, error } = await supabase
    .from('elementos_mapa')
    .select('*')
    .eq('ativo', true)

  if(error) throw error

  data.forEach(el=>{
    const div=document.createElement('div')
    div.className='elemento'
    div.innerHTML=`<img src="${el.url_da_imagem}">`
    ;(el.tipo==='reservavel'?listaRes:listaNao).appendChild(div)
  })
}

/* ================= LOAD MAPA ================= */
async function carregarMapa(){
  status.textContent = 'Carregando mapa…'

  const { data, error } = await supabase
    .from('mapa_mesas')
    .select('*')

  if(error) throw error

  for(const row of data){
    const { data: el, error: eErr } = await supabase
      .from('elementos_mapa')
      .select('*')
      .eq('id', row.elemento_id)
      .single()

    if(eErr) throw eErr

    const item=document.createElement('div')
    item.className='item-mapa'
    item.style.left=row.x+'px'
    item.style.top=row.y+'px'
    item.innerHTML=`<img src="${el.url_da_imagem}">`
    mapa.appendChild(item)
  }
}

/* ================= INIT ================= */
(async()=>{
  try{
    await carregarElementos()
    await carregarMapa()
    overlay.classList.add('hidden')
  }catch(err){
    console.error(err)
    overlay.classList.add('error')
    overlay.innerHTML = `
      <h2>Erro ao carregar</h2>
      <small>${err.message}</small>
    `
  }
})()
</script>

</body>
</html>
