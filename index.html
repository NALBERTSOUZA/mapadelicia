<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa de Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:Inter, Arial, sans-serif;
  background:#f4f4f5;
  height:100vh;
  overflow:hidden;
}

/* HEADER */
header{
  height:64px;
  background:linear-gradient(90deg,#0f172a,#020617);
  color:#fff;
  display:flex;
  align-items:center;
  gap:12px;
  padding:0 16px;
}

header strong{
  font-size:18px;
  margin-right:12px;
}

header select,
header input{
  height:36px;
  padding:0 10px;
  border-radius:8px;
  border:none;
}

header button{
  height:36px;
  padding:0 16px;
  border:none;
  border-radius:8px;
  background:#22c55e;
  color:#fff;
  font-weight:700;
  cursor:pointer;
  position:relative;
}

/* BOT√ÉO LOADING */
header button.loading{
  pointer-events:none;
  opacity:.7;
}

header button.loading::after{
  content:'';
  width:18px;
  height:18px;
  border:3px solid #fff;
  border-top:3px solid transparent;
  border-radius:50%;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  animation:spin .8s linear infinite;
}

@keyframes spin{
  to{transform:translate(-50%,-50%) rotate(360deg)}
}

/* PALCO */
#palco{
  position:relative;
  height:calc(100vh - 64px);
  background:#e5e7eb;
}

/* MESA */
.mesa{
  position:absolute;
  width:96px;
  height:96px;
  background:#cbd5e1;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:grab;
  user-select:none;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}

.redonda{border-radius:50%}
.quadrada{border-radius:14px}

.ocupada{
  background:#f59e0b;
  color:#fff;
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
}

#modal .box{
  background:#fff;
  padding:20px;
  width:300px;
  border-radius:12px;
}

#modal input{
  width:100%;
  padding:10px;
  margin-top:10px;
}

#modal button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.salvar{background:#0f172a;color:#fff}
.liberar{background:#ef4444;color:#fff}
</style>
</head>

<body>

<header>
  <strong>üçΩÔ∏è MESAS</strong>

  <select id="tipo">
    <option value="quadrada">Quadrada</option>
    <option value="redonda">Redonda</option>
  </select>

  <input id="lugares" type="number" min="1" placeholder="Lugares">

  <button id="btnAdd">+ ADICIONAR MESA</button>
</header>

<div id="palco"></div>

<div id="modal">
  <div class="box">
    <h3>Reserva</h3>
    <input id="cliente" placeholder="Nome do cliente">
    <button class="salvar">Salvar</button>
    <button class="liberar">Liberar mesa</button>
  </div>
</div>

<script>
/* ====== SUPABASE ====== */
const SUPABASE_URL = "https://pkpmzbjvsapzeuqtvytm.supabase.co";
const SUPABASE_KEY = "sb_publishable_UIy2gATpA5WzOIgeXHvqlw_IpSiwdsh";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====== ELEMENTOS ====== */
const palco = document.getElementById('palco');
const modal = document.getElementById('modal');
const btnAdd = document.getElementById('btnAdd');

let mesaAtual = null;

/* ====== ADICIONAR MESA (COM OVERLAY E ERRO) ====== */
btnAdd.onclick = async () => {
  const tipoMesa = document.getElementById('tipo').value;
  const lugaresInput = document.getElementById('lugares');
  const lugares = parseInt(lugaresInput.value);

  if(!lugares || lugares <= 0){
    alert("Informe a quantidade de lugares");
    return;
  }

  btnAdd.classList.add('loading');

  try{
    const { data, error } = await supabase
      .from('mesas')
      .insert({
        tipo: tipoMesa,
        lugares: lugares,
        x: 150,
        y: 150
      })
      .select()
      .single();

    if(error) throw error;

    desenharMesa(data);
    lugaresInput.value = '';

  }catch(err){
    console.error("Erro ao adicionar mesa:", err);
    alert("Erro ao salvar no Supabase:\n" + err.message);
  }finally{
    btnAdd.classList.remove('loading');
  }
};

/* ====== DESENHAR MESA ====== */
function desenharMesa(m){
  const el = document.createElement('div');
  el.className = `mesa ${m.tipo} ${m.status}`;
  el.style.left = m.x + 'px';
  el.style.top = m.y + 'px';
  el.innerText = m.lugares;

  el.onmousedown = e => drag(e, m, el);
  el.onclick = e => {
    e.stopPropagation();
    abrirModal(m, el);
  };

  palco.appendChild(el);
}

/* ====== DRAG ====== */
function drag(e, m, el){
  const ox = e.clientX - el.offsetLeft;
  const oy = e.clientY - el.offsetTop;

  document.onmousemove = ev => {
    el.style.left = ev.clientX - ox + 'px';
    el.style.top = ev.clientY - oy + 'px';
  };

  document.onmouseup = async () => {
    document.onmousemove = null;
    await supabase
      .from('mesas')
      .update({
        x: parseInt(el.style.left),
        y: parseInt(el.style.top)
      })
      .eq('id', m.id);
  };
}

/* ====== MODAL ====== */
function abrirModal(m, el){
  mesaAtual = { m, el };
  cliente.value = m.cliente || '';
  modal.style.display = 'flex';
}

document.querySelector('.salvar').onclick = async () => {
  await supabase
    .from('mesas')
    .update({ cliente: cliente.value, status: 'ocupada' })
    .eq('id', mesaAtual.m.id);

  mesaAtual.el.classList.add('ocupada');
  modal.style.display = 'none';
};

document.querySelector('.liberar').onclick = async () => {
  await supabase
    .from('mesas')
    .update({ cliente: null, status: 'livre' })
    .eq('id', mesaAtual.m.id);

  mesaAtual.el.classList.remove('ocupada');
  modal.style.display = 'none';
};

modal.onclick = e => {
  if(e.target === modal) modal.style.display = 'none';
};

/* ====== LOAD ====== */
async function carregar(){
  const { data, error } = await supabase.from('mesas').select('*');
  if(error){
    console.error("Erro ao carregar mesas:", error);
    return;
  }
  data.forEach(desenharMesa);
}
carregar();
</script>

</body>
</html>
