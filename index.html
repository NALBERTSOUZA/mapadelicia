<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Organizar Mesas e Reservas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    header {
      background-color: #333;
      color: #fff;
      padding: 15px;
      width: 100%;
      text-align: center;
    }

    .container {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    #palco {
      flex: 1;
      height: 500px;
      background-color: #eaeaea;
      position: relative;
    }

    .mesa {
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      cursor: grab;
      background-color: #3498db;
      color: white;
      border-radius: 8px;
      padding: 10px;
    }

    .redonda {
      border-radius: 50%;
    }

    .quadrada {
      width: 100px;
      height: 100px;
    }

    .livre {
      background-color: #3498db;
    }

    .ocupada {
      background-color: #f39c12;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
    }

    .modal-content input,
    .modal-content button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
    }

    .reservas-list {
      flex: 1;
      margin-left: 20px;
    }

    .reservas-list ul {
      list-style-type: none;
    }
  </style>
</head>

<body>

<header>
  <h1>Organizar Mesas e Reservas</h1>
</header>

<div class="container">
  <div id="palco"></div>
  <div class="reservas-list">
    <h3>Reservas</h3>
    <ul id="reservas-list"></ul>
  </div>
</div>

<!-- Modal para adicionar reservas -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Reservar Mesa</h3>
    <input type="text" id="nome_cliente" placeholder="Nome do Cliente">
    <input type="text" id="telefone" placeholder="Telefone">
    <input type="number" id="qtd_pessoas" placeholder="Quantidade de Pessoas">
    <button id="salvarReserva">Salvar Reserva</button>
    <button id="cancelarReserva">Cancelar</button>
  </div>
</div>

<script>
  const supabase = supabase.createClient(
    'https://your-project.supabase.co', 
    'your-public-api-key'
  );

  let mesas = [];
  let reservas = [];

  // Carregar mesas e reservas do Supabase
  async function carregarMesas() {
    const { data, error } = await supabase.from('mesas').select('*');
    if (error) {
      console.error('Erro ao carregar mesas:', error);
    } else {
      mesas = data;
      desenharMesas();
    }
  }

  async function carregarReservas() {
    const { data, error } = await supabase.from('reservas').select('*');
    if (error) {
      console.error('Erro ao carregar reservas:', error);
    } else {
      reservas = data;
      atualizarListaReservas();
    }
  }

  // Atualizar lista de reservas
  function atualizarListaReservas() {
    const lista = document.getElementById('reservas-list');
    lista.innerHTML = '';
    reservas.forEach(reserva => {
      const li = document.createElement('li');
      li.innerHTML = `${reserva.nome_cliente} - ${reserva.qtd_pessoas} pessoas`;
      lista.appendChild(li);
    });
  }

  // Desenhar as mesas no palco
  function desenharMesas() {
    const palco = document.getElementById('palco');
    palco.innerHTML = ''; // Limpar palco
    mesas.forEach(mesa => {
      const mesaElement = document.createElement('div');
      mesaElement.classList.add('mesa', mesa.tipo, mesa.status);
      mesaElement.style.left = `${mesa.x}px`;
      mesaElement.style.top = `${mesa.y}px`;
      mesaElement.innerText = `${mesa.nome}`;
      mesaElement.onclick = () => abrirModalReserva(mesa);
      mesaElement.onmousedown = (e) => iniciarArraste(e, mesa, mesaElement);
      palco.appendChild(mesaElement);
    });
  }

  // Iniciar arraste das mesas
  function iniciarArraste(e, mesa, mesaElement) {
    const offsetX = e.clientX - mesaElement.offsetLeft;
    const offsetY = e.clientY - mesaElement.offsetTop;

    document.onmousemove = (ev) => {
      mesaElement.style.left = `${ev.clientX - offsetX}px`;
      mesaElement.style.top = `${ev.clientY - offsetY}px`;
    };

    document.onmouseup = async () => {
      document.onmousemove = null;
      const x = parseInt(mesaElement.style.left);
      const y = parseInt(mesaElement.style.top);
      await supabase.from('mesas').update({ x, y }).eq('id', mesa.id);
    };
  }

  // Abrir o modal para adicionar reserva
  function abrirModalReserva(mesa) {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('salvarReserva').onclick = () => salvarReserva(mesa);
  }

  // Salvar reserva
  async function salvarReserva(mesa) {
    const nome_cliente = document.getElementById('nome_cliente').value;
    const telefone = document.getElementById('telefone').value;
    const qtd_pessoas = document.getElementById('qtd_pessoas').value;

    if (!nome_cliente || !telefone || !qtd_pessoas) return;

    const { data, error } = await supabase.from('reservas').insert([{
      mesa_id: mesa.id,
      nome_cliente,
      telefone,
      qtd_pessoas,
      status: 'pendente',
    }]);

    if (error) {
      console.error('Erro ao salvar reserva:', error);
    } else {
      reservas.push(data[0]);
      atualizarListaReservas();
      document.getElementById('modal').style.display = 'none';
    }
  }

  // Cancelar reserva
  document.getElementById('cancelarReserva').onclick = () => {
    document.getElementById('modal').style.display = 'none';
  };

  // Inicializar
  carregarMesas();
  carregarReservas();
</script>

</body>
</html>
