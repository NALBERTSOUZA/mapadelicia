<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Reservas de Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f5f6f8;
  --mesa-ocupada:#ff9800;
  --mesa-paga:#2ecc71;
}

body{
  margin:0;
  font-family:Inter;
  background:var(--bg);
}

/* HEADER */
header{
  padding:14px 20px;
  background:#111;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

header span{
  font-weight:700;
}

/* BARRA ADMIN */
#adminBar{
  display:flex;
  gap:10px;
}

#adminBar input,
#adminBar select,
#adminBar button{
  padding:8px;
  border-radius:6px;
  border:none;
}

#adminBar button{
  background:#2ecc71;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* MAPA */
#mapa{
  position:relative;
  width:100%;
  height:calc(100vh - 64px);
  background:#fff;
  overflow:hidden;
}

/* MESA */
.mesa{
  position:absolute;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  cursor:grab;
  user-select:none;
  border:2px dashed #ccc;
}

.redonda{
  width:90px;
  height:90px;
  border-radius:50%;
}

.quadrada{
  width:80px;
  height:80px;
}

.livre{
  background:transparent;
}

.ocupada{
  background:var(--mesa-ocupada);
  color:#fff;
  border:none;
}

.paga{
  background:var(--mesa-paga);
  color:#fff;
  border:none;
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}

#modal .box{
  background:#fff;
  width:360px;
  border-radius:12px;
  padding:20px;
}

.box h3{
  margin-top:0;
}

.box input,
.box select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
}

.box button{
  width:100%;
  padding:12px;
  background:#111;
  color:#fff;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <span>üìç Sistema de Reservas</span>

  <!-- ADMIN -->
  <div id="adminBar">
    <input id="mesaNome" placeholder="Nome da mesa">
    <select id="mesaTipo">
      <option value="redonda">Redonda</option>
      <option value="quadrada">Quadrada</option>
    </select>
    <input id="mesaCapacidade" type="number" placeholder="Lugares">
    <button onclick="adicionarMesa()">+ Adicionar mesa</button>
  </div>
</header>

<div id="mapa"></div>

<!-- MODAL RESERVA -->
<div id="modal">
  <div class="box">
    <h3>Reserva da Mesa</h3>
    <input id="nome" placeholder="Nome do cliente">
    <input id="telefone" placeholder="Telefone">
    <input id="qtd" type="number" placeholder="Qtd de pessoas">
    <select id="status">
      <option value="ocupada">Ocupada (n√£o paga)</option>
      <option value="paga">Paga</option>
      <option value="livre">Livre</option>
    </select>
    <button onclick="salvarReserva()">Salvar</button>
  </div>
</div>

<script>
const supabase = supabase.createClient(
  "https://pkpmzbjvsapzeuqtvytm.supabase.co",
  "sb_publishable_UIy2gATpA5WzOIgeXHvqlw_IpSiwdsh"
);

const mapa = document.getElementById('mapa');
const modal = document.getElementById('modal');

let mesaAtual = null;
let offsetX, offsetY;

/* ======================
   ADICIONAR MESA
====================== */
async function adicionarMesa(){
  const nome = mesaNome.value;
  const tipo = mesaTipo.value;
  const capacidade = mesaCapacidade.value;

  if(!nome || !capacidade){
    alert("Preencha nome e capacidade");
    return;
  }

  await supabase.from('mesas').insert({
    nome,
    tipo,
    capacidade,
    x: 50,
    y: 50,
    status: 'livre'
  });

  mesaNome.value = '';
  mesaCapacidade.value = '';

  carregarMesas();
}

/* ======================
   CARREGAR MESAS
====================== */
async function carregarMesas(){
  mapa.innerHTML = '';
  const { data } = await supabase.from('mesas').select('*');

  data.forEach(m => {
    const div = document.createElement('div');
    div.className = `mesa ${m.tipo} ${m.status}`;
    div.innerText = `${m.nome}\n(${m.capacidade})`;
    div.style.left = m.x + 'px';
    div.style.top = m.y + 'px';

    div.onmousedown = e => iniciarDrag(e, m, div);
    div.onclick = () => abrirModal(m);

    mapa.appendChild(div);
  });
}

carregarMesas();

/* ======================
   DRAG
====================== */
function iniciarDrag(e, mesa, el){
  mesaAtual = mesa;
  offsetX = e.offsetX;
  offsetY = e.offsetY;

  document.onmousemove = ev => {
    el.style.left = ev.pageX - offsetX + 'px';
    el.style.top = ev.pageY - offsetY - 64 + 'px';
  };

  document.onmouseup = async () => {
    document.onmousemove = null;
    document.onmouseup = null;

    await supabase.from('mesas').update({
      x: parseInt(el.style.left),
      y: parseInt(el.style.top)
    }).eq('id', mesa.id);
  };
}

/* ======================
   RESERVA
====================== */
function abrirModal(m){
  mesaAtual = m;
  modal.style.display = 'flex';

  nome.value = m.nome_cliente || '';
  telefone.value = m.telefone || '';
  qtd.value = m.qtd_pessoas || '';
  status.value = m.status || 'livre';
}

async function salvarReserva(){
  await supabase.from('mesas').update({
    nome_cliente: nome.value,
    telefone: telefone.value,
    qtd_pessoas: qtd.value,
    status: status.value
  }).eq('id', mesaAtual.id);

  modal.style.display = 'none';
  carregarMesas();
}

modal.onclick = e => {
  if(e.target === modal) modal.style.display = 'none';
};
</script>

</body>
</html>
